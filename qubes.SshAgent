#!/bin/sh
SSA_DIRECTORY="$HOME/.ssa"
TIMEOUT=10

DEFAULT_FILE="$SSA_DIRECTORY/.default"

DIALOG_TEXT="A SSH key has been requested. Please choose one, or cancel."

# find_keys() finds all keys and
find_keys() {

  KEYS_STRING=""
  DEFAULT_KEY=$(cat $DEFAULT_FILE)

  for KEY in $SSA_DIRECTORY/*.pub; do
    KEY_BASENAME=$(basename $KEY .pub)

    # Default key will be already selected in prompt
    if [ "$KEY_BASENAME" = "$DEFAULT_KEY" ] ; then
      DEFAULT="True"
    else
      DEFAULT="False"
    fi

    KEYS_STRING="$KEYS_STRING $DEFAULT $KEY_BASENAME"

  done
  echo $KEYS_STRING
}

# Prompt user for key selection
SELECTED=$(zenity --list --radiolist --title "SSH key selection" --text="$DIALOG_TEXT" --column=Select --column=Key $(find_keys) >& /dev/null)
KEY_FILE=$SSA_DIRECTORY/$SELECTED

# Exit if nothing selected
if [ -z $SELECTED ] ; then
  exit 1
fi

# Save default key selection
echo $SELECTED > $DEFAULT_FILE

# Make sure ssh-add is happy with permissions
chmod 0700 $SSA_DIRECTORY
chmod 0600 $SSA_DIRECTORY/*

# Start ssh-agent, add key
eval $(ssh-agent) > /dev/null
ssh-add $KEY_FILE > /dev/null

# Connect to ssh-agent, proxying over stdio
socat - UNIX-CONNECT:$SSH_AUTH_SOCK &
SOCAT_PID=$!

if [ $TIMEOUT -gt 0 ] ; then
  (sleep $TIMEOUT && kill $SOCAT_PID) &
fi

wait $SOCAT_PID

# Clean up
kill $SSH_AGENT_PID
